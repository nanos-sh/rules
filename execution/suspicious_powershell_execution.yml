---
title: suspicious_powershell_encoded_execution
description: Detects PowerShell execution with suspicious command-line patterns including encoded commands, download cradles, AMSI bypass attempts, and execution policy bypasses.
author: nanos.sh
severity: high
mode: staging
detection_mode: scheduled
schedule: "*/2 * * * *"
lookback: 5m
mitre_tactics:
  - TA0002
  - TA0005
mitre_techniques:
  - T1059.001
  - T1027
  - T1562.001
tags:
  - powershell
  - obfuscation
  - windows
ai_triage_hints:
  ignore_when:
    - "Command is from SCCM, Intune, or other management tools"
    - "Script is a known IT automation (check hash against approved scripts)"
    - "User is a developer running build scripts"
  suspicious_when:
    - "Multiple obfuscation techniques in single command"
    - "Parent process is Office application or browser"
    - "Command downloads and executes in memory (fileless)"
    - "AMSI bypass detected alongside other suspicious patterns"
  context: "PowerShell is heavily abused by attackers. Encoded commands hide malicious intent. Check the decoded command content and investigate the parent process chain to understand how PowerShell was invoked."
---
source_type=windows_sysmon OR source_type=windows_security OR source_type=endpoint_edr
| where action="process_create"
| where process_name="powershell.exe" OR process_name="pwsh.exe"
| where command_line~"-e[ncodedcommand]*" OR command_line~"-enc " OR command_line CONTAINS "IEX" OR command_line CONTAINS "Invoke-Expression" OR command_line CONTAINS "downloadstring"
| risk score=50 entity=src_host factor="Suspicious PowerShell"
| where command_line CONTAINS "-enc"
| risk score=70 factor="Encoded command"
| where command_line CONTAINS "IEX" OR command_line CONTAINS "Invoke-Expression"
| risk score=85 factor="Download cradle"
| where command_line CONTAINS "amsi"
| risk score=95 factor="AMSI bypass attempt"
| where parent_process IN ("winword.exe", "excel.exe", "outlook.exe")
| risk score=95 factor="Office parent process"
| table timestamp, src_host, user, process_name, parent_process, command_line, risk_score, risk_factors
