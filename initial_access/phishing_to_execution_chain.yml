---
title: phishing_email_to_execution_chain
description: Detects the full phishing attack chain - email with suspicious characteristics opened, link clicked to external domain, followed by file download and execution. This sequence captures the complete attack flow.
author: nanos.sh
severity: critical
mode: staging
detection_mode: scheduled
schedule: "*/5 * * * *"
lookback: 30m
folder: endpoint
mitre_tactics:
  - TA0001
  - TA0002
mitre_techniques:
  - T1566.001
  - T1566.002
  - T1204.001
  - T1204.002
tags:
  - phishing
  - sequence
  - email
  - initial_access
ai_triage_hints:
  ignore_when:
    - "Email is from a known vendor or partner domain"
    - "User is in security team testing phishing defenses"
    - "Downloaded file is a known safe application"
  suspicious_when:
    - "Email subject contains urgency keywords (urgent, suspended, verify)"
    - "Link domain was recently registered"
    - "Downloaded file has low prevalence"
    - "Execution occurred within minutes of download"
  context: "This is a complete phishing attack chain. Immediately isolate the endpoint if the executed file is suspicious. Check if other users received the same email. Block the sender domain and link URL across the organization."
---
source_type=email_gateway OR source_type=endpoint_edr OR source_type=proxy
| sequence by user, src_host maxspan=30m
    fields(subject, sender, url, file_path, process_name, command_line)
    [action="email_received" subject=/(urgent|verify|suspended|action.required|password|security.alert)/i]
    [action="url_click" url_domain!=/company\.com$/i]
    [file_action="create" file_path=/\.(exe|scr|bat|cmd|ps1|vbs|js|hta|msi|dll|jar)$/i]
    [action="process_create"]
| risk score=90 entity=user factor="Complete phishing chain"
| where sequence_duration < 300
| risk score=95 factor="Rapid execution after download"
| table timestamp, user, src_host, subject, sender, url, file_path, process_name, sequence_duration, risk_score, risk_factors
